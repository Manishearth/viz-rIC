<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Flot Examples: Real-time updates</title>
    <link href="examples.css" rel="stylesheet" type="text/css">
    <!--[if lte IE 8]><script language="javascript" type="text/javascript" src="../../excanvas.min.js"></script><![endif]-->
    <script language="javascript" type="text/javascript" src="flot/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="flot/jquery.flot.js"></script>
    <script type="text/javascript">

      var toogle;
      var useAF;

      $(function() {

        // We use an inline data source in the example, usually data would
        // be fetched from a server

        var data = [];

        var data = new Array(300).fill(0);

        function getData() {
          let ymax = 1;
          let res = new Array(300);
          for (let i in data) {
            let v =  data[i];
            ymax = Math.max(ymax, v);
            res[i] = [i, v];
          }
          return {ymax: Math.round(ymax * 1.1), data: res};
        }

        var counter = 0;
        var running = false;
        var maxTime = 0;

        toggle = function toggle() {
          useAF = document.getElementById("useAF").checked;
          running = !running;
          update();
          requestIdleCallback(callback);
        }

        function callback(d) {
          data = data.slice(1);
          let rem = d.timeRemaining();
          data.push(rem);
          let t = +document.getElementById('idleperiod').value;
          t = Math.max(rem - t, 0);
          while (t < d.timeRemaining()) {

          }

          if (running) {
            requestIdleCallback(callback);
          }
        }

        // Set up the control widget

        var updateInterval = 30;
        $("#updateInterval").val(updateInterval).change(function () {
          var v = $(this).val();
          if (v && !isNaN(+v)) {
            updateInterval = +v;
            if (updateInterval < 1) {
              updateInterval = 1;
            } else if (updateInterval > 2000) {
              updateInterval = 2000;
            }
            $(this).val("" + updateInterval);
          }
        });

        var plot = $.plot("#placeholder", [ getData() ], {
          series: {
            shadowSize: 0       // Drawing is faster without shadows
          },
          yaxis: {
            min: 0
          },
          xaxis: {
            show: false
          }
        });

        function update() {

          if (!running) {
            return;
          }

          var data = getData();
          var yaxes = plot.getYAxes();

          plot.getOptions().yaxes[0].max = data.ymax;
          plot.setupGrid();
          plot.setData([data.data]);
          plot.draw();

          if (useAF) {
            requestAnimationFrame(update);
          } else {
            setTimeout(update, updateInterval);
          }
        }

        update();

        // Add the Flot version string to the footer

        $("#footer").prepend("Flot " + $.plot.version + " &ndash; ");
      });

      function toggleAF() {
        useAF = document.getElementById("useAF").checked;
        document.getElementById("updateInterval").disabled = useAF;
      }
    </script>
  </head>
  <body>

    <div id="header">
      <h2>Real-time updates</h2>
    </div>

    <div id="content">

      <div class="demo-container">
        <div id="placeholder" class="demo-placeholder"></div>
      </div>

      <p>You can update a chart periodically to get a real-time effect by using a timer to insert the new data in the plot and redraw it.</p>

      <p>Time between updates: <input id="updateInterval" type="text" value="" style="text-align: right; width:5em"> milliseconds</p>

    </div>

    <p>Use requestAnimationFrame: <input id="useAF" type="checkbox" onclick="toggleAF()"> milliseconds</p>

    <p>Time to spend in idle callback <input type="text" id="idleperiod" value="10"/></p>

    <input type="button" onclick="toggle()" value="Toggle" />

    <div id="footer">
      Copyright &copy; 2007 - 2014 IOLA and Ole Laursen
    </div>

  </body>
</html>
